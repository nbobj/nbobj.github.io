<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"><title>01nginx基础 | XYZhi's学习笔记</title><meta name="keywords" content="nginx"><meta name="author" content="xyz"><meta name="copyright" content="xyz"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="description" content="nginx在架构体系中的位置和作用 网关面向客户的总入口。  虚拟主机一台机器为不同的域名&#x2F;ip&#x2F;端口提供服务  路由使用反向代理，整合后续服务为一个完整业务  静态服务器mvvm模式中，用来发布前端html&#x2F;css&#x2F;js&#x2F;img  负载集群使用upstream，负载多个tomcat  高度模块化的设计是 Nginx 的架构基础。Nginx 服务器">
<meta property="og:type" content="article">
<meta property="og:title" content="01nginx基础">
<meta property="og:url" content="http://sv.pointcut.cc/blog/nginx/01nginx%E5%9F%BA%E7%A1%80/index.html">
<meta property="og:site_name" content="XYZhi&#39;s学习笔记">
<meta property="og:description" content="nginx在架构体系中的位置和作用 网关面向客户的总入口。  虚拟主机一台机器为不同的域名&#x2F;ip&#x2F;端口提供服务  路由使用反向代理，整合后续服务为一个完整业务  静态服务器mvvm模式中，用来发布前端html&#x2F;css&#x2F;js&#x2F;img  负载集群使用upstream，负载多个tomcat  高度模块化的设计是 Nginx 的架构基础。Nginx 服务器">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="http://sv.pointcut.cc/linear-gradient(20deg,%20#0062be,%20#925696,%20#cc426e,%20#fb0347)">
<meta property="article:published_time" content="2021-11-15T12:00:01.000Z">
<meta property="article:modified_time" content="2022-03-23T09:03:57.502Z">
<meta property="article:author" content="xyz">
<meta property="article:tag" content="nginx">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="http://sv.pointcut.cc/linear-gradient(20deg,%20#0062be,%20#925696,%20#cc426e,%20#fb0347)"><link rel="shortcut icon" href="/img/favicon.png"><link rel="canonical" href="http://sv.pointcut.cc/blog/nginx/01nginx%E5%9F%BA%E7%A1%80/"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6/css/all.min.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/node-snackbar/dist/snackbar.min.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox.css" media="print" onload="this.media='all'"><script>const GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: {"path":"search.xml","languages":{"hits_empty":"找不到您查询的内容：${query}"}},
  translate: undefined,
  noticeOutdate: undefined,
  highlight: {"plugin":"highlighjs","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":400},
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '天',
  date_suffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: {"limitCount":50,"languages":{"author":"作者: xyz","link":"链接: ","source":"来源: XYZhi's学习笔记","info":"著作权归作者所有。商业转载请联系作者获得授权，非商业转载请注明出处。"}},
  lightbox: 'fancybox',
  Snackbar: {"chs_to_cht":"你已切换为繁体","cht_to_chs":"你已切换为简体","day_to_night":"你已切换为深色模式","night_to_day":"你已切换为浅色模式","bgLight":"#49b1f5","bgDark":"#1f1f1f","position":"top-right"},
  source: {
    justifiedGallery: {
      js: 'https://cdn.jsdelivr.net/npm/flickr-justified-gallery@2/dist/fjGallery.min.js',
      css: 'https://cdn.jsdelivr.net/npm/flickr-justified-gallery@2/dist/fjGallery.min.css'
    }
  },
  isPhotoFigcaption: false,
  islazyload: false,
  isAnchor: true
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: '01nginx基础',
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isToc: true,
  postUpdate: '2022-03-23 17:03:57'
}</script><noscript><style type="text/css">
  #nav {
    opacity: 1
  }
  .justified-gallery img {
    opacity: 1
  }

  #recent-posts time,
  #post-meta time {
    display: inline !important
  }
</style></noscript><script>(win=>{
    win.saveToLocal = {
      set: function setWithExpiry(key, value, ttl) {
        if (ttl === 0) return
        const now = new Date()
        const expiryDay = ttl * 86400000
        const item = {
          value: value,
          expiry: now.getTime() + expiryDay,
        }
        localStorage.setItem(key, JSON.stringify(item))
      },

      get: function getWithExpiry(key) {
        const itemStr = localStorage.getItem(key)

        if (!itemStr) {
          return undefined
        }
        const item = JSON.parse(itemStr)
        const now = new Date()

        if (now.getTime() > item.expiry) {
          localStorage.removeItem(key)
          return undefined
        }
        return item.value
      }
    }
  
    win.getScript = url => new Promise((resolve, reject) => {
      const script = document.createElement('script')
      script.src = url
      script.async = true
      script.onerror = reject
      script.onload = script.onreadystatechange = function() {
        const loadState = this.readyState
        if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
        script.onload = script.onreadystatechange = null
        resolve()
      }
      document.head.appendChild(script)
    })
  
      win.activateDarkMode = function () {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      win.activateLightMode = function () {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }
      const t = saveToLocal.get('theme')
    
          const isDarkMode = window.matchMedia('(prefers-color-scheme: dark)').matches
          const isLightMode = window.matchMedia('(prefers-color-scheme: light)').matches
          const isNotSpecified = window.matchMedia('(prefers-color-scheme: no-preference)').matches
          const hasNoSupport = !isDarkMode && !isLightMode && !isNotSpecified

          if (t === undefined) {
            if (isLightMode) activateLightMode()
            else if (isDarkMode) activateDarkMode()
            else if (isNotSpecified || hasNoSupport) {
              const now = new Date()
              const hour = now.getHours()
              const isNight = hour <= 6 || hour >= 18
              isNight ? activateDarkMode() : activateLightMode()
            }
            window.matchMedia('(prefers-color-scheme: dark)').addListener(function (e) {
              if (saveToLocal.get('theme') === undefined) {
                e.matches ? activateDarkMode() : activateLightMode()
              }
            })
          } else if (t === 'light') activateLightMode()
          else activateDarkMode()
        
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        if (asideStatus === 'hide') {
          document.documentElement.classList.add('hide-aside')
        } else {
          document.documentElement.classList.remove('hide-aside')
        }
      }
    
    const detectApple = () => {
      if(/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)){
        document.documentElement.classList.add('apple')
      }
    }
    detectApple()
    })(window)</script><meta name="generator" content="Hexo 6.1.0"></head><body><div id="loading-box"><div class="loading-left-bg"></div><div class="loading-right-bg"></div><div class="spinner-box"><div class="configure-border-1"><div class="configure-core"></div></div><div class="configure-border-2"><div class="configure-core"></div></div><div class="loading-word">加载中...</div></div></div><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img is-center"><img src="/images/avatar.png" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="site-data is-center"><div class="data-item"><a href="/archives/"><div class="headline">文章</div><div class="length-num">301</div></a></div><div class="data-item"><a href="/tags/"><div class="headline">标签</div><div class="length-num">14</div></a></div><div class="data-item"><a href="/categories/"><div class="headline">分类</div><div class="length-num">6</div></a></div></div><hr/><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 主页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 文章</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-list"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header" style="background: linear-gradient(20deg, #0062be, #925696, #cc426e, #fb0347)"><nav id="nav"><span id="blog_name"><a id="site-name" href="/">XYZhi's学习笔记</a></span><div id="menus"><div id="search-button"><a class="site-page social-icon search"><i class="fas fa-search fa-fw"></i><span> 搜索</span></a></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 主页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 文章</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-list"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></div></div><div id="toggle-menu"><a class="site-page"><i class="fas fa-bars fa-fw"></i></a></div></div></nav><div id="post-info"><h1 class="post-title">01nginx基础</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" datetime="2021-11-15T12:00:01.000Z" title="发表于 2021-11-15 20:00:01">2021-11-15</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" datetime="2022-03-23T09:03:57.502Z" title="更新于 2022-03-23 17:03:57">2022-03-23</time></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-wordcount"><i class="far fa-file-word fa-fw post-meta-icon"></i><span class="post-meta-label">字数总计:</span><span class="word-count">4.6k</span><span class="post-meta-separator">|</span><i class="far fa-clock fa-fw post-meta-icon"></i><span class="post-meta-label">阅读时长:</span><span>18分钟</span></span><span class="post-meta-separator">|</span><span class="post-meta-pv-cv" id="" data-flag-title="01nginx基础"><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">阅读量:</span><span id="busuanzi_value_page_pv"></span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container"><h2 id="nginx在架构体系中的位置和作用"><a href="#nginx在架构体系中的位置和作用" class="headerlink" title="nginx在架构体系中的位置和作用"></a>nginx在架构体系中的位置和作用</h2><ul>
<li>网关<br>面向客户的总入口。 </li>
<li>虚拟主机<br>一台机器为不同的域名&#x2F;ip&#x2F;端口提供服务 </li>
<li>路由<br>使用反向代理，整合后续服务为一个完整业务 </li>
<li>静态服务器<br>mvvm模式中，用来发布前端html&#x2F;css&#x2F;js&#x2F;img </li>
<li>负载集群<br>使用upstream，负载多个tomcat</li>
</ul>
<p>高度模块化的设计是 Nginx 的架构基础。Nginx 服务器被分解为多个模块，每个模块就是一个功能模块，只负责自身的功能，模块之间严格遵循“高内聚，低耦合”的原则。</p>
<p><img src="https://cdn.jsdelivr.net/gh/XieYueZhi/cdn/spring/9079500731129426954.png" alt="image-20210318204328504"></p>
<p>Nginx使用epoll模式来处理请求。</p>
<p>反向代理：</p>
<p><img src="https://cdn.jsdelivr.net/gh/XieYueZhi/cdn/spring/9079500731129426955.png" alt="image-20210318205745963"></p>
<p>Nginx多进程模型：</p>
<p>服务器每当收到一个客户端时。就有服务器主进程（master process）生成一个子进程（worker process）出来和客户端建立连接进行交互，直到连接断开，该子进程结束。</p>
<p>Nginx会按需同时运行多个进程，一个主进程(master)和几个工作进程(worker)，配置了缓存时还会有缓存加载器进程(cache loader)和缓存管理器进程(cache manager)等。</p>
<p>所有进程均是仅含有一个线程，并主要通过“共享内存”的机制实现进程间通信。</p>
<p>主进程以root用户身份运行，而worker、cache loader和cache manager均应以非特权用户身份（user配置项）运行。</p>
<p>主进程主要完成如下工作：</p>
<ol>
<li><p>读取并验正配置信息；</p>
</li>
<li><p>创建、绑定及关闭套接字；</p>
</li>
<li><p>启动、终止及维护worker进程的个数；</p>
</li>
<li><p>无须中止服务而重新配置工作特性；</p>
</li>
<li><p>重新打开日志文件；</p>
</li>
</ol>
<p>worker进程主要完成的任务包括：</p>
<ol>
<li><p>接收、传入并处理来自客户端的连接；</p>
</li>
<li><p>提供反向代理及过滤功能；</p>
</li>
<li><p>nginx任何能完成的其它任务；</p>
</li>
</ol>
<h2 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h2><p>docker:</p>
<p><a target="_blank" rel="noopener" href="http://hub.daocloud.io/repos/2b7310fb-1a50-48f2-9586-44622a2d1771">http://hub.daocloud.io/repos/2b7310fb-1a50-48f2-9586-44622a2d1771</a></p>
<p>Mac:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">brew update</span><br><span class="line">brew install nginx</span><br></pre></td></tr></table></figure>

<p>ubuntu:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">apt update</span><br><span class="line">apt install nginx</span><br></pre></td></tr></table></figure>

<p>Linux通用：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">wget  http://nginx.org/download/nginx-1.15.8.tar.gz #自己改下版本</span><br><span class="line">tar -zxvf nginx-1.15.8.tar.gz</span><br><span class="line">cd nginx-1.15.8</span><br><span class="line"></span><br><span class="line">#--prefix指定安装目录</span><br><span class="line">#--with-http_ssl_module安装https模块</span><br><span class="line">#creating objs/Makefile 代表编译成功</span><br><span class="line">./configure  --prefix=/usr/local/nginx --with-http_stub_status_module --with-http_ssl_module </span><br><span class="line"></span><br><span class="line">#make编译</span><br><span class="line">#make install安装</span><br><span class="line">make &amp;&amp; make install </span><br></pre></td></tr></table></figure>

<h3 id="nginx安装第三方模块"><a href="#nginx安装第三方模块" class="headerlink" title="nginx安装第三方模块"></a>nginx安装第三方模块</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">./configure --add-module=模块的目录</span><br><span class="line">make &amp;&amp; make install</span><br></pre></td></tr></table></figure>



<h2 id="Nginx目录结构"><a href="#Nginx目录结构" class="headerlink" title="Nginx目录结构"></a>Nginx目录结构</h2><ul>
<li>conf 配置文件</li>
<li>html  网页文件</li>
<li>logs  日志文件</li>
<li>sbin  二进制程序</li>
</ul>
<h2 id="Nginx常用命令"><a href="#Nginx常用命令" class="headerlink" title="Nginx常用命令"></a>Nginx常用命令</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">nginx -c nginx.conf # 指定配置文件。如果不指定，默认为NGINX_HOME/conf/nginx.conf</span><br><span class="line"></span><br><span class="line">nginx -s stop # 停止</span><br><span class="line"></span><br><span class="line">nginx -s quit # 退出</span><br><span class="line"></span><br><span class="line">nginx -s reload # 重新加载nginx.conf</span><br><span class="line"></span><br><span class="line">nginx -V # 查看安装的第三方插件</span><br></pre></td></tr></table></figure>



<h2 id="nginx-conf配置文件结构"><a href="#nginx-conf配置文件结构" class="headerlink" title="nginx.conf配置文件结构"></a>nginx.conf配置文件结构</h2><p><a href="./nginx%E9%85%8D%E7%BD%AE%E6%B3%A8%E8%A7%A3">nginx.conf</a></p>
<p><img src="https://cdn.jsdelivr.net/gh/XieYueZhi/cdn/spring/9079500731129426956.png" alt="image-20210318212203219"></p>
<blockquote>
<p>默认情况下只支持http应用。</p>
<p>从1.9.0开始，新增加了一个stream模块，用来实现四层协议的转发、代理或者负载均衡等。能tcp负载均衡、udp(dns)负载均衡、redis代理或zk服务代理等。</p>
<p>需要安装<code>--with-stream </code></p>
<p>配置如下：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line">stream &#123;    # stream 模块配置和 http 模块在相同级别</span><br><span class="line">    upstream redis &#123;</span><br><span class="line">        server 127.0.0.1:6379 max_fails=3 fail_timeout=30s weight=5;</span><br><span class="line">    &#125;</span><br><span class="line">    server &#123;</span><br><span class="line">        listen 16379;</span><br><span class="line">        proxy_connect_timeout 1s;</span><br><span class="line">        proxy_timeout 3s;</span><br><span class="line">        proxy_pass redis;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">stream &#123;</span><br><span class="line">    upstream backend &#123;</span><br><span class="line">        hash $remote_addr consistent;</span><br><span class="line">        server 127.0.0.1:12346 weight=5;</span><br><span class="line">        server 127.0.0.1:12347 max_fails=3 fail_timeout=30s;</span><br><span class="line">        server 127.0.0.1:12348 max_fails=3 fail_timeout=30s;</span><br><span class="line">    &#125;</span><br><span class="line">    server &#123;</span><br><span class="line">        listen 12345;</span><br><span class="line">        proxy_connect_timeout 1s;</span><br><span class="line">        proxy_timeout 3s;</span><br><span class="line">        proxy_pass backend;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    upstream dns &#123;</span><br><span class="line">       server 17.61.29.79:53;</span><br><span class="line">       server 17.61.29.80:53;</span><br><span class="line">       server 17.61.29.81:53;</span><br><span class="line">       server 17.61.29.82:53;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    server &#123;</span><br><span class="line">        listen 127.0.0.1:53 udp;</span><br><span class="line">        proxy_responses 1;</span><br><span class="line">        proxy_timeout 20s;</span><br><span class="line">        proxy_pass dns;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


</blockquote>
<h2 id="Nginx配置"><a href="#Nginx配置" class="headerlink" title="Nginx配置"></a>Nginx配置</h2><h3 id="demo"><a href="#demo" class="headerlink" title="demo"></a>demo</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line">#user  nobody;</span><br><span class="line">worker_processes  1;</span><br><span class="line"></span><br><span class="line">error_log  logs/error.log;</span><br><span class="line">#error_log  logs/error.log  notice;</span><br><span class="line">#error_log  logs/error.log  info;</span><br><span class="line"></span><br><span class="line">#pid        logs/nginx.pid;</span><br><span class="line"></span><br><span class="line">events &#123;</span><br><span class="line">    worker_connections  1024;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">http &#123;</span><br><span class="line">    include       mime.types;</span><br><span class="line">   # default_type  application/octet-stream;</span><br><span class="line">    default_type  text/plain;</span><br><span class="line"></span><br><span class="line">    log_format  peter  &#x27;$remote_addr - $remote_user [$time_local] &quot;$request&quot; &#x27;;</span><br><span class="line">    log_format  access  &#x27;$remote_addr &#x27;;</span><br><span class="line"></span><br><span class="line">    access_log  logs/access.log  peter;</span><br><span class="line"></span><br><span class="line">    sendfile        on;</span><br><span class="line">    #tcp_nopush     on;</span><br><span class="line"></span><br><span class="line">    #keepalive_timeout  0;</span><br><span class="line">    keepalive_timeout  65;</span><br><span class="line"></span><br><span class="line">    #gzip  on;</span><br><span class="line"></span><br><span class="line">    server &#123;</span><br><span class="line">        listen       8080;</span><br><span class="line">        server_name  enjoy.com;</span><br><span class="line"></span><br><span class="line">        location / &#123;</span><br><span class="line">            root   /etc/nginx/html;</span><br><span class="line">            index  c.html;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        error_page   500 502 503 504  /50x.html;</span><br><span class="line">        location = /50x.html &#123;</span><br><span class="line">            root   html;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="带注解的配置"><a href="#带注解的配置" class="headerlink" title="带注解的配置"></a>带注解的配置</h3><p><a href="./nginx%E9%85%8D%E7%BD%AE%E6%B3%A8%E8%A7%A3">nginx配置注解</a></p>
<h3 id="Nginx日志"><a href="#Nginx日志" class="headerlink" title="Nginx日志"></a>Nginx日志</h3><p>Nginx日志对于统计、系统服务排错很有用。</p>
<p>Nginx日志主要分为两种：access_log(访问日志)和error_log(错误日志)。</p>
<p>通过访问日志我们可以得到用户的IP地址、浏览器的信息，请求的处理时间等信息。</p>
<p>错误日志记录了访问出错的信息，可以帮助我们定位错误的原因。</p>
<p>因此，将日志好好利用，可以得到很多有价值的信息。</p>
<h4 id="设置access-log"><a href="#设置access-log" class="headerlink" title="设置access_log"></a>设置access_log</h4><p>访问日志主要记录客户端的请求。客户端向Nginx服务器发起的每一次请求都记录在这里。客户端IP，浏览器信息，referer，请求处理时间，请求URL等都可以在访问日志中得到。当然具体要记录哪些信息，你可以通过log_format指令定义。</p>
<ol>
<li>access_log path [format [buffer&#x3D;size] [gzip[&#x3D;level]] [flush&#x3D;time] [if&#x3D;condition]]; # 设置访问日志</li>
<li>access_log off; #关闭访问日志</li>
</ol>
<ul>
<li>path 指定日志的存放位置。</li>
<li>format 指定日志的格式。默认使用预定义的combined。</li>
<li>buffer 用来指定日志写入时的缓存大小。默认是64k。</li>
<li>gzip 日志写入前先进行压缩。压缩率可以指定，从1到9数值越大压缩比越高，同时压缩的速度也越慢。默认是1。</li>
<li>flush 设置缓存的有效时间。如果超过flush指定的时间，缓存中的内容将被清空。</li>
<li>if 条件判断。如果指定的条件计算为0或空字符串，那么该请求不会写入日志。</li>
<li>另外，还有一个特殊的值off。如果指定了该值，当前作用域下的所有的请求日志都被关闭。</li>
</ul>
<p>事例</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">access_log /var/logs/nginx-access.log buffer=32k gzip flush=1m;  </span><br></pre></td></tr></table></figure>

<h4 id="log-format自定义格式"><a href="#log-format自定义格式" class="headerlink" title="log_format自定义格式"></a>log_format自定义格式</h4><p>各参数明细表：</p>
<table>
<thead>
<tr>
<th></th>
<th></th>
</tr>
</thead>
<tbody><tr>
<td>$remote_addr</td>
<td>客户端的ip地址(代理服务器，显示代理服务ip)</td>
</tr>
<tr>
<td>$remote_user</td>
<td>用于记录远程客户端的用户名称（一般为“-”）</td>
</tr>
<tr>
<td>$time_local</td>
<td>用于记录访问时间和时区</td>
</tr>
<tr>
<td>$request</td>
<td>用于记录请求的url以及请求方法</td>
</tr>
<tr>
<td>$status</td>
<td>响应状态码，例如：200成功、404页面找不到等。</td>
</tr>
<tr>
<td>$body_bytes_sent</td>
<td>给客户端发送的文件主体内容字节数</td>
</tr>
<tr>
<td>$http_user_agent</td>
<td>用户所使用的代理（一般为浏览器）</td>
</tr>
<tr>
<td>$http_x_forwarded_for</td>
<td>可以记录客户端IP，通过代理服务器来记录客户端的ip地址</td>
</tr>
<tr>
<td>$http_referer</td>
<td>可以记录用户是从哪个链接访问过来的</td>
</tr>
</tbody></table>
<p>事例</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">log_format  main  &#x27;$remote_addr - $remote_user [$time_local] &quot;$request&quot; &#x27;</span><br><span class="line">                      &#x27;$status $body_bytes_sent &quot;$http_referer&quot; &#x27;</span><br><span class="line">                      &#x27;&quot;$http_user_agent&quot; &quot;$http_x_forwarded_for&quot;&#x27;; </span><br></pre></td></tr></table></figure>

<h4 id="设置error-log"><a href="#设置error-log" class="headerlink" title="设置error_log"></a>设置error_log</h4><p>错误日志在Nginx中是通过error_log指令实现的。该指令记录服务器和请求处理过程中的错误信息。</p>
<p>错误日志不支持自定义。</p>
<p><strong>语法：</strong></p>
<p>error_log path [level];</p>
<ul>
<li>path参数指定日志的写入位置。</li>
<li>level参数指定日志的级别（不写为全部）。level可以是debug, info, notice, warn, error, crit, alert,emerg中的任意值（等级从低到高排列）。<br>只有日志的错误级别等于或高于level指定的值才会写入错误日志中。默认值是error。</li>
</ul>
<p>事例</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">error_log  logs/error.log; </span><br><span class="line">error_log  logs/error_notice.log  notice;</span><br><span class="line">error_log  logs/error_info.log  info;	</span><br></pre></td></tr></table></figure>

<h4 id="日志配置和及切割"><a href="#日志配置和及切割" class="headerlink" title="日志配置和及切割"></a>日志配置和及切割</h4><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">/etc/init.d/rsyslog start  <span class="comment">#系统日志，如不开启，看不到定时任务日志</span></span><br><span class="line">/etc/rc.d/init.d/crond start	<span class="comment">#定时任务开启</span></span><br></pre></td></tr></table></figure>

<p>编写sh：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">#</span><span class="language-bash">!/bin/bash</span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">设置日志文件存放目录</span></span><br><span class="line">LOG_HOME=&quot;/usr/local/nginx/logs/&quot;</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">备分文件名称</span></span><br><span class="line">LOG_PATH_BAK=&quot;$(date -d yesterday +%Y%m%d%H%M)&quot;</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">重命名日志文件</span></span><br><span class="line">mv $&#123;LOG_HOME&#125;/access.log $&#123;LOG_HOME&#125;/access.$&#123;LOG_PATH_BAK&#125;.log</span><br><span class="line">mv $&#123;LOG_HOME&#125;/error.log $&#123;LOG_HOME&#125;/error.$&#123;LOG_PATH_BAK&#125;.log</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">向nginx主进程发信号重新打开日志</span></span><br><span class="line">kill -USR1 `cat $&#123;LOG_HOME&#125;/nginx.pid`</span><br></pre></td></tr></table></figure>

<p>配置cron：</p>
<p>执行命令</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">crontab -e</span><br></pre></td></tr></table></figure>

<p>然后在里面添加下面的命令</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">*/1 * * * * /usr/local/nginx/sbin/logcut.sh</span><br></pre></td></tr></table></figure>

<h3 id="虚拟主机"><a href="#虚拟主机" class="headerlink" title="虚拟主机"></a>虚拟主机</h3><p>主配置文件</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line">#user  nobody;</span><br><span class="line">worker_processes  1;</span><br><span class="line"></span><br><span class="line">error_log  /Users/xyz/markdown/mweb/nginx/demo/logs/error.log;</span><br><span class="line">#error_log  logs/error.log  notice;</span><br><span class="line">#error_log  logs/error.log  info;</span><br><span class="line"></span><br><span class="line">pid        /Users/xyz/markdown/mweb/nginx/demo/logs/nginx.pid;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">events &#123;</span><br><span class="line">    worker_connections  1024;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">http &#123;</span><br><span class="line">    # include       mime.types;</span><br><span class="line">   # default_type  application/octet-stream;</span><br><span class="line">    default_type  text/plain;</span><br><span class="line"></span><br><span class="line">    #日志匹配</span><br><span class="line">    log_format  peter  &#x27;$remote_addr - $remote_user [$time_local] &quot;$request&quot; &#x27;;</span><br><span class="line">    log_format  access  &#x27;$remote_addr &#x27;;</span><br><span class="line"></span><br><span class="line">    #输出peter的日志</span><br><span class="line">    access_log  /Users/xyz/markdown/mweb/nginx/demo/logs/access.log  peter;</span><br><span class="line"></span><br><span class="line">    sendfile        on;</span><br><span class="line">    #tcp_nopush     on;</span><br><span class="line"></span><br><span class="line">    #keepalive_timeout  0;</span><br><span class="line">    keepalive_timeout  65;</span><br><span class="line"></span><br><span class="line">    #gzip  on;</span><br><span class="line"></span><br><span class="line">    include /Users/xyz/markdown/mweb/nginx/demo/conf/server/*.conf;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>看最后，有一行<code>include ...../*.conf;</code>，这就表示引入该目录下的.conf文件。这些文件可以是一个个的server配置文件。</p>
<p>比如a.conf</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">server &#123;</span><br><span class="line">        listen       9669;</span><br><span class="line">        server_name  xyza.com;</span><br><span class="line">        access_log  /Users/xyz/markdown/mweb/nginx/demo/logs/access_a.log  peter;</span><br><span class="line"></span><br><span class="line">        location / &#123;</span><br><span class="line">            root   /Users/xyz/markdown/mweb/nginx/demo/html;</span><br><span class="line">            index  a.html;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        error_page   500 502 503 504  /50x.html;</span><br><span class="line">        location = /50x.html &#123;</span><br><span class="line">            root   html;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>b.conf</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">server &#123;</span><br><span class="line">        listen       9669;</span><br><span class="line">        server_name  xyzb.com;</span><br><span class="line">        access_log  /Users/xyz/markdown/mweb/nginx/demo/logs/access_b.log  peter;</span><br><span class="line"></span><br><span class="line">        location / &#123;</span><br><span class="line">            root   /Users/xyz/markdown/mweb/nginx/demo/html;</span><br><span class="line">            index  b.html;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        error_page   500 502 503 504  /50x.html;</span><br><span class="line">        location = /50x.html &#123;</span><br><span class="line">            root   html;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>



<h3 id="路由——Location的使用"><a href="#路由——Location的使用" class="headerlink" title="路由——Location的使用"></a>路由——Location的使用</h3><p><img src="https://cdn.jsdelivr.net/gh/XieYueZhi/cdn/spring/9079500731129426957.png" alt="image-20210323192319808"></p>
<h4 id="语法规则"><a href="#语法规则" class="headerlink" title="语法规则"></a>语法规则</h4><p>location [&#x3D;|~|~*|^~|空格] &#x2F;uri&#x2F; {… }</p>
<table>
<thead>
<tr>
<th>符号</th>
<th>含义</th>
</tr>
</thead>
<tbody><tr>
<td>&#x3D;</td>
<td>&#x3D; 开头表示精确匹配</td>
</tr>
<tr>
<td>^~</td>
<td>^~开头表示uri以某个常规字符串开头，理解为匹配 url路径即可（禁止正则匹配）。</td>
</tr>
<tr>
<td>空格</td>
<td>空格开头表示uri以某个常规字符串开头。</td>
</tr>
<tr>
<td>~</td>
<td>~ 开头表示区分大小写的正则匹配</td>
</tr>
<tr>
<td>~*</td>
<td>~* 开头表示不区分大小写的正则匹配</td>
</tr>
<tr>
<td>!~和!~*</td>
<td>!~和!~*分别为区分大小写不匹配及不区分大小写不匹配的正则</td>
</tr>
<tr>
<td>&#x2F;</td>
<td>用户所使用的代理（一般为浏览器）</td>
</tr>
</tbody></table>
<p>location指令优先级验证：</p>
<ol>
<li>&#x3D;精准匹配，最优，匹配就直接返回</li>
<li>^~，空  为一般匹配，收集所有匹配，取最长匹配执行（此时不返回，还会执行下面的正则匹配）</li>
<li>*~，~* 为正则匹配，按顺序依次匹配，命中即返回（可能会覆盖普通匹配），没命中就放回普通匹配中匹配最长的。</li>
</ol>
<p><img src="https://cdn.jsdelivr.net/gh/XieYueZhi/cdn/spring/9079500731129426958.png" alt="image-20210323215759171"></p>
<h4 id="语法规则总结"><a href="#语法规则总结" class="headerlink" title="语法规则总结"></a>语法规则总结</h4><p>先总结下在做测试，用下面的伪代码做总结</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">比如去掉服务名后的字符串为url</span><br><span class="line">if url == .. &#123;</span><br><span class="line">	return location1</span><br><span class="line">&#125; else &#123;</span><br><span class="line">	temp</span><br><span class="line">	if url.startWith(str1) &#123;</span><br><span class="line">			temp = location2</span><br><span class="line">	&#125; </span><br><span class="line">	if url.startWith(str2) &#123;</span><br><span class="line">			if temp == null || str2.len &gt; str1.len &#123;</span><br><span class="line">				temp = location3</span><br><span class="line">			&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	...</span><br><span class="line">	if temp != null &amp;&amp; temp.contains(^~) &#123;</span><br><span class="line">		return temp;</span><br><span class="line">	&#125; else &#123;</span><br><span class="line">    if (pattern1.metcher(url).find()) &#123;</span><br><span class="line">    	return location4</span><br><span class="line">    &#125;</span><br><span class="line">    if (pattern2.metcher(url).find()) &#123;</span><br><span class="line">    	return location5</span><br><span class="line">    &#125;</span><br><span class="line">	&#125;</span><br><span class="line">	return temp;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="location测试"><a href="#location测试" class="headerlink" title="location测试"></a>location测试</h4><p>下面是用于测试location.conf文件。其中echo需要引入第三方的模块ngx_echo。</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#location指令优先级验证：</span></span><br><span class="line"><span class="comment">#	=精准匹配，最优，匹配就直接返回</span></span><br><span class="line"><span class="comment">#	^~,空 为一般匹配，收集所有匹配，取最长匹配执行（此时不返回，还会执行下面的正则匹配）</span></span><br><span class="line"><span class="comment">#	~,~* 为正则匹配，按顺序依次匹配，命中即返回（可能会覆盖普通匹配）</span></span><br><span class="line"></span><br><span class="line"><span class="string">server</span> &#123;</span><br><span class="line"></span><br><span class="line">	<span class="string">listen</span>       <span class="number">80</span><span class="string">;</span></span><br><span class="line">	<span class="string">server_name</span>  <span class="string">loc.enjoy.com;</span></span><br><span class="line"></span><br><span class="line">	<span class="comment">#精准匹配测试</span></span><br><span class="line">	<span class="comment">#第1，2条虽然匹配，但第三条是精准匹配，出第三条结果</span></span><br><span class="line">	<span class="comment">#测试路径/equal/a/b/c</span></span><br><span class="line">	<span class="string">location</span> <span class="string">~</span> <span class="string">/equal/*</span> &#123;<span class="comment">#被命中，但被下面的推断：location = /equal/a/b/c</span></span><br><span class="line">		<span class="string">echo</span> <span class="string">&#x27;/equal/*&#x27;</span><span class="string">;</span></span><br><span class="line">	&#125;</span><br><span class="line">	<span class="string">location</span> <span class="string">/equal/a/b</span> &#123;<span class="comment">#被命中，但被下面的推断：location = /equal/a/b/c</span></span><br><span class="line">		<span class="string">echo</span> <span class="string">&#x27;/equal/a/b&#x27;</span><span class="string">;</span></span><br><span class="line">	&#125;</span><br><span class="line">	<span class="string">location</span> <span class="string">=</span> <span class="string">/equal/a/b/c</span> &#123;<span class="comment">#被命中，直接执行，不等待</span></span><br><span class="line">		<span class="string">echo</span> <span class="string">&#x27;/equal/a/b/c&#x27;</span><span class="string">;</span></span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">#普通匹配测试</span></span><br><span class="line">	<span class="comment">#第1，2条虽然匹配，第三条匹配更长，出第三条结果</span></span><br><span class="line">	<span class="comment">#测试路径/match/a/b/c</span></span><br><span class="line">	<span class="string">location</span> <span class="string">/match/a</span> &#123;<span class="comment">#被命中，但不是最长</span></span><br><span class="line">		<span class="string">return</span> <span class="number">200</span>  <span class="string">&quot;/match/a&quot;</span><span class="string">;</span></span><br><span class="line">	&#125;</span><br><span class="line">	<span class="string">location</span> <span class="string">/match/a/b</span> &#123;<span class="comment">#被命中，但不是最长</span></span><br><span class="line">		<span class="string">return</span> <span class="number">200</span>  <span class="string">&quot;/match/a/b&quot;</span><span class="string">;</span>	</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="string">location</span> <span class="string">/match/a/b/c</span> &#123;<span class="comment">#被命中，且最长</span></span><br><span class="line">		 <span class="string">return</span> <span class="number">200</span>  <span class="string">&quot;/match/a/b/c&quot;</span><span class="string">;</span></span><br><span class="line">	&#125;</span><br><span class="line">	<span class="string">location</span> <span class="string">/match/a/b/c/d</span> &#123;<span class="comment">#不命中</span></span><br><span class="line">		<span class="string">return</span> <span class="number">200</span>  <span class="string">&quot;/match/a/b/c/d&quot;</span><span class="string">;</span> </span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">#正则匹配覆盖普通匹配测试</span></span><br><span class="line">	<span class="comment">#会覆盖普通匹配，不会覆盖=和^~</span></span><br><span class="line">	<span class="string">location</span> <span class="string">=/re/a.js</span> &#123;<span class="comment">#访问/re/a.js，不会被后面的正则覆盖</span></span><br><span class="line">		<span class="string">echo</span> <span class="string">&#x27;match =&#x27;</span><span class="string">;</span></span><br><span class="line">	&#125;</span><br><span class="line">	<span class="string">location</span> <span class="string">^~</span> <span class="string">/re/a/b</span> &#123;<span class="comment">#访问/re/a/b开头的路径，不会被后面的正则覆盖</span></span><br><span class="line">		<span class="string">echo</span> <span class="string">&#x27;math ^~/re/a/b*&#x27;</span><span class="string">;</span></span><br><span class="line">	&#125;</span><br><span class="line">	<span class="string">location</span> <span class="string">/re/a.htm</span> &#123;<span class="comment">#访问/re/a.htm，会被后面的正则覆盖</span></span><br><span class="line">		 <span class="string">echo</span> <span class="string">&#x27;match /re/a.htm&#x27;</span><span class="string">;</span></span><br><span class="line">	&#125;</span><br><span class="line">	<span class="string">location</span> <span class="string">~</span> <span class="string">/re/(.*)\.(htm|js|css)$</span> &#123;<span class="comment">#覆盖/re/a.htm路径</span></span><br><span class="line">		<span class="string">echo</span> <span class="string">&quot;cover /re/$1.$2&quot;</span><span class="string">;</span></span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">#正则匹配成功一条后，便不再走其它正则</span></span><br><span class="line">	<span class="comment">#最长正则匹配是第三个，但匹配第一个后便不往下走</span></span><br><span class="line">	<span class="comment">#测试路径/rex/a/b/c.htm</span></span><br><span class="line">	<span class="string">location</span> <span class="string">~</span> <span class="string">/rex/.*\.(htm|js|css)$</span> &#123;<span class="comment">#覆盖/re/a.htm路径</span></span><br><span class="line">		<span class="string">echo</span> <span class="string">&quot;match first&quot;</span><span class="string">;</span></span><br><span class="line">	&#125;</span><br><span class="line">	<span class="string">location</span> <span class="string">~</span> <span class="string">/rex/a/(.*)\.(htm|js|css)$</span> &#123;<span class="comment">#覆盖/re/a.htm路径</span></span><br><span class="line">		<span class="string">echo</span> <span class="string">&quot;match second&quot;</span><span class="string">;</span></span><br><span class="line">	&#125;</span><br><span class="line">	<span class="string">location</span> <span class="string">~</span> <span class="string">/rex/a/b/(.*)\.(htm|js|css)$</span> &#123;<span class="comment">#覆盖/re/a.htm路径</span></span><br><span class="line">		<span class="string">echo</span> <span class="string">&quot;match third&quot;</span><span class="string">;</span></span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="string">location</span> <span class="string">/</span> &#123;</span><br><span class="line">            <span class="string">root</span>   <span class="string">/etc/nginx/html;</span></span><br><span class="line">            <span class="string">index</span>  <span class="string">c.html;</span></span><br><span class="line">        &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h5 id="测试1"><a href="#测试1" class="headerlink" title="测试1"></a>测试1</h5><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">http://loc.enjoy.com/equal/a/b/c</span><br><span class="line">预测结果：页面显示：/equal/a/b/c</span><br></pre></td></tr></table></figure>

<p><img src="https://cdn.jsdelivr.net/gh/XieYueZhi/cdn/spring/9079500731129426959.png" alt="image-20210324020123867"></p>
<p>结果：</p>
<p><img src="https://cdn.jsdelivr.net/gh/XieYueZhi/cdn/spring/9079500731129426960.png" alt="image-20210324020259014"></p>
<h5 id="测试2"><a href="#测试2" class="headerlink" title="测试2"></a>测试2</h5><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">http://loc.enjoy.com/match/a/b/c</span><br><span class="line">预测结果：页面显示：/match/a/b/c</span><br></pre></td></tr></table></figure>

<p><img src="https://cdn.jsdelivr.net/gh/XieYueZhi/cdn/spring/9079500731129426961.png" alt="image-20210324020338170"></p>
<p>结果：</p>
<p><img src="https://cdn.jsdelivr.net/gh/XieYueZhi/cdn/spring/9079500731129426962.png" alt="image-20210324020434470"></p>
<h5 id="测试3"><a href="#测试3" class="headerlink" title="测试3"></a>测试3</h5><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">http://loc.enjoy.com/re/a/b/c.htm</span><br><span class="line">预测结果：页面显示：math ^~/re/a/b*</span><br></pre></td></tr></table></figure>

<p><img src="https://cdn.jsdelivr.net/gh/XieYueZhi/cdn/spring/9079500731129426963.png" alt="image-20210324020447803"></p>
<p>结果:</p>
<p><img src="https://cdn.jsdelivr.net/gh/XieYueZhi/cdn/spring/9079500731129426964.png" alt="image-20210324020655532"></p>
<h5 id="测试4"><a href="#测试4" class="headerlink" title="测试4"></a>测试4</h5><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">http://loc.enjoy.com/rex/a/b/c.htm</span><br><span class="line">预测结果：页面显示：match first</span><br></pre></td></tr></table></figure>

<p><img src="https://cdn.jsdelivr.net/gh/XieYueZhi/cdn/spring/9079500731129426965.png" alt="image-20210324020707238"></p>
<p>结果：</p>
<p><img src="https://cdn.jsdelivr.net/gh/XieYueZhi/cdn/spring/9079500731129426966.png" alt="image-20210324020811057"></p>
<h3 id="反向代理"><a href="#反向代理" class="headerlink" title="反向代理"></a>反向代理</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">server &#123;</span><br><span class="line">        listen       80;</span><br><span class="line">        server_name	pxy.enjoy.com;</span><br><span class="line"></span><br><span class="line">	#后台服务原始路径：http://192.168.0.132:8088/mvc/index?id=2</span><br><span class="line"></span><br><span class="line">	#无/，访问路径：http://pxy.enjoy.com/mvc/index?id=2</span><br><span class="line">	location /mvc &#123;</span><br><span class="line">               #此处未关闭，传递整个路径/nginx/enjoy/getInfo到目标ip:port</span><br><span class="line">               proxy_pass http://192.168.0.132:8088;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        #有/，访问路径 ：http://pxy.enjoy.com/nginx/mvc/index?id=2</span><br><span class="line">        location /nginx/mvc &#123;#匹配路径/nginx/mvc，剩余路径/index?id=2</span><br><span class="line">                proxy_pass http://192.168.0.132:8088/mvc;</span><br><span class="line">        &#125;</span><br><span class="line">       </span><br><span class="line">    &#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p><img src="https://cdn.jsdelivr.net/gh/XieYueZhi/cdn/spring/9079500731129426967.png" alt="image-20210324021408498"></p>
<p>会把匹配到的内容<code>/mvc/index?id=2</code>和代理的地址进行拼接，最会回去调用</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http://192.168.0.132:8088/mvc/index?id=2</span><br></pre></td></tr></table></figure>

<p>这个服务。</p>
<p><img src="https://cdn.jsdelivr.net/gh/XieYueZhi/cdn/spring/9079500731129426968.png" alt="image-20210324022016416"></p>
<p>这种情况如果还是按上面的逻辑处理的话最终地址变成了</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http://192.168.0.132:8088/mvc/nginx/mvc/index?id=2</span><br></pre></td></tr></table></figure>

<p>这不是我们希望的，所以nginx会有一些规则</p>
<p><img src="https://cdn.jsdelivr.net/gh/XieYueZhi/cdn/spring/9079500731129426969.png" alt="image-20210324022415955"></p>
<p>以上图为例，ip:prot是用来定位server的而path是用来做location匹配的，在location匹配时path可以看出有两部分，第一部分是匹配的，第二部分是未匹配的。上图以path1和path2分别表示。</p>
<p>这种时候有两种处理逻辑：</p>
<ol>
<li>如果代理的地址是ip:port时，转发的地址就变成了ip:port+path1+path2</li>
<li>如果代理的地址是ip:port&#x2F;时，转发的地址就变成了ip:port+path2</li>
</ol>
<p>所以，对于上边的，最终转发地址为：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http://192.168.0.132:8088/mvc/index?id=2</span><br></pre></td></tr></table></figure>

<h3 id="静态代理"><a href="#静态代理" class="headerlink" title="静态代理"></a>静态代理</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">server &#123;</span><br><span class="line">        listen       80;</span><br><span class="line">        server_name	pxy.enjoy.com;</span><br><span class="line"></span><br><span class="line">	#访问路径：http://pxy.enjoy.com/static/d.html 	</span><br><span class="line">	location /static &#123;#匹配路径/static，剩余路径/a.html</span><br><span class="line">		root /etc/nginx/html/;#root声明，在html文件夹，查找/static/a.html文件</span><br><span class="line">        &#125;</span><br><span class="line">	#访问路径：http://pxy.enjoy.com/target/d.html </span><br><span class="line">	location /target &#123;#匹配路径/target，剩余路径/a.html</span><br><span class="line">                alias /etc/nginx/html/static/;##alias声明，在static/文件夹，查找a.html文件</span><br><span class="line">        &#125;	</span><br><span class="line">       </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>上面对两种声名，root和alias</p>
<ul>
<li><p>root很简单粗暴，就是匹配后，把整个path去指定的目录下查找，对应上边的就是找这个文件</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/etc/nginx/html/static/d.html</span><br></pre></td></tr></table></figure>
</li>
<li><p>alias意识是别名，就是把匹配到的字符作为一个路径的别名，这样的话只需要找别名后边的路径的资源就好了，对应上边的是找这个文件</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/etc/nginx/html/static/d.html</span><br></pre></td></tr></table></figure></li>
</ul>
<h3 id="rewrite使用"><a href="#rewrite使用" class="headerlink" title="rewrite使用"></a>rewrite使用</h3><h4 id="语法"><a href="#语法" class="headerlink" title="语法"></a>语法</h4><p>rewrite regex replacement [flag]</p>
<ul>
<li>regex 是正则表达式</li>
<li>replacement 是替换值，新值</li>
<li>flag – 后续处理标识，flag&#x3D;[break|last|redirect|permanent]</li>
</ul>
<h4 id="flag各个参数说明"><a href="#flag各个参数说明" class="headerlink" title="flag各个参数说明"></a>flag各个参数说明</h4><ul>
<li>flag&#x3D;break<br>发生nginx内部重定向，path值被更新，rewrite层面的命令会中断。原控制流程逻辑不变往下走</li>
<li>flag&#x3D;last<br>发生nginx内部重定向，path值被更新，rewrite层面的命令会中断。控制流程刷新，重新进行整个location层的逻辑流程。</li>
<li>flag&#x3D; redirect&#x2F;permanent<br>发生页面重定向（301永久重定向&#x2F;302临时重定向），nginx流程结束，返回http响应到浏览器，页面url更新</li>
<li>flag为空<br>发生nginx内部重定向，path值被更新，rewrite层面的命令继续。最后一个rewrite完毕，刷新控制流程，重新进行location重匹配</li>
</ul>
<h4 id="使用"><a href="#使用" class="headerlink" title="使用"></a>使用</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line">server &#123;</span><br><span class="line">	listen       80;</span><br><span class="line">	server_name  rew.enjoy.com;</span><br><span class="line"></span><br><span class="line">	location /a.html &#123;</span><br><span class="line">		echo &#x27;I am a.html&#x27;;</span><br><span class="line">	&#125;</span><br><span class="line">	location /b.html &#123;</span><br><span class="line">		echo &#x27;I am b.html&#x27;;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	#此路径请求：http://rew.enjoy.com/aa.html</span><br><span class="line">	location /aa.html &#123;##内部重定向</span><br><span class="line">		rewrite ^/  /a.html break;##停止指令，流程不变往下走		</span><br><span class="line">		rewrite ^/  /b.html break;	</span><br><span class="line">		root   /etc/nginx/html/;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	#此路径请求：http://rew.enjoy.com/ab.html</span><br><span class="line">	location /ab.html &#123;</span><br><span class="line">		rewrite ^/  /a.html last;##停止指令，但重新location匹配</span><br><span class="line">		rewrite ^/  /b.html last;</span><br><span class="line">		rewrite ^/  /c.html;</span><br><span class="line">		root   /etc/nginx/html/;		</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	#此路径请求：http://rew.enjoy.com/bb</span><br><span class="line">	location /bb &#123;</span><br><span class="line">		rewrite ^/  /b.html redirect;##302临时重定向</span><br><span class="line">		set $aa 12;</span><br><span class="line">		root   html/;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	#此路径请求：http://rew.enjoy.com/ba</span><br><span class="line">	location /ba &#123;</span><br><span class="line">		rewrite ^/  /b.html permanent;##301永久重定向</span><br><span class="line">		root   html/;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	#此路径请求：http://rew.enjoy.com/cc.html</span><br><span class="line">	location /cc.html &#123;</span><br><span class="line">    rewrite ^/  /c.html;##指令不停，继续往下</span><br><span class="line">    rewrite ^/  /b.html;</span><br><span class="line">    rewrite ^/  /a.html;##最后一条，生效的是这条</span><br><span class="line">    root   /etc/nginx/html/;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="负载均衡——upstream"><a href="#负载均衡——upstream" class="headerlink" title="负载均衡——upstream"></a>负载均衡——upstream</h3><h4 id="语法-1"><a href="#语法-1" class="headerlink" title="语法"></a>语法</h4><p>放在server外，语法：</p>
<p>upstream 负载名 { </p>
<p>​    [ip_hash;]</p>
<p>​    server ip:port  [weight&#x3D;数字]  [down]; </p>
<p>​    server ip:port  [weight&#x3D;数字];</p>
<p>} </p>
<h4 id="使用-1"><a href="#使用-1" class="headerlink" title="使用"></a>使用</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">upstream order &#123;</span><br><span class="line">	ip_hash;</span><br><span class="line">	server 192.168.0.128:8383 weight=3;</span><br><span class="line">	server 192.168.244.1:8383 weight=1;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">server &#123;</span><br><span class="line">  listen       80;</span><br><span class="line">  server_name  test.enjoy.com;</span><br><span class="line"></span><br><span class="line">	location /order/enjoy &#123;</span><br><span class="line">    ##后台请求为：http://192.168.0.128:8383/enjoy/getPage</span><br><span class="line">		##调整后请求：http://test.enjoy.com/order/enjoy/getPage</span><br><span class="line">		##故代理需要关闭/order/enjoy的传递</span><br><span class="line">		proxy_pass http://order/enjoy;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<blockquote>
<p>上边的配置中，server的proxy_pass 地址中的<code>order</code>是指upstream的别名，可以认为就是指ip:port。剩下的对于真实地址的生成的规则还是和proxy_pass的一样</p>
</blockquote>
<h4 id="ip-hash"><a href="#ip-hash" class="headerlink" title="ip_hash"></a>ip_hash</h4><p>每个请求按访问ip的hash结果分配，这样同一客户端的请求总是发往同一个后端服务器。</p>
<p>场景：可以解决session的登陆问题（不想用缓存保存seesion的情况）</p>
<h4 id="weight"><a href="#weight" class="headerlink" title="weight"></a>weight</h4><p>权重，如果不填写，默认值即为1。</p>
<p>每个请求按照顺序逐一分配到不同的后端服务器，如果后端服务器down掉，能自动剔除。</p>
<p>如果填写后，weight&#x2F;总weight的概率访问。</p>
<h4 id="down"><a href="#down" class="headerlink" title="down"></a>down</h4><p>在后面加上down，表示不参与负载</p>
<p>场景：服务器升级、程序更新</p>
</article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">文章作者: </span><span class="post-copyright-info"><a href="mailto:undefined">xyz</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">文章链接: </span><span class="post-copyright-info"><a href="http://sv.pointcut.cc/blog/nginx/01nginx%E5%9F%BA%E7%A1%80/">http://sv.pointcut.cc/blog/nginx/01nginx基础/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="http://sv.pointcut.cc" target="_blank">XYZhi's学习笔记</a>！</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/nginx/">nginx</a></div><div class="post_share"></div></div><div class="post-nav"><a class="pre" href="/blog/nginx/02nginx%E8%BF%9B%E9%98%B6/">02nginx进阶</a><a class="next" href="/blog/redis/%E7%BC%93%E5%AD%98%E9%9B%AA%E5%B4%A9%E3%80%81%E5%87%BB%E7%A9%BF%E3%80%81%E7%A9%BF%E9%80%8F/">缓存雪崩、击穿、穿透</a></div></div><div class="aside-content" id="aside-content"><div class="card-widget card-info"><div class="is-center"><div class="avatar-img"><img src="/images/avatar.png" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/></div><div class="author-info__name">xyz</div><div class="author-info__description"></div></div><div class="card-info-data is-center"><div class="card-info-data-item"><a href="/archives/"><div class="headline">文章</div><div class="length-num">301</div></a></div><div class="card-info-data-item"><a href="/tags/"><div class="headline">标签</div><div class="length-num">14</div></a></div><div class="card-info-data-item"><a href="/categories/"><div class="headline">分类</div><div class="length-num">6</div></a></div></div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>目录</span><span class="toc-percentage"></span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#nginx%E5%9C%A8%E6%9E%B6%E6%9E%84%E4%BD%93%E7%B3%BB%E4%B8%AD%E7%9A%84%E4%BD%8D%E7%BD%AE%E5%92%8C%E4%BD%9C%E7%94%A8"><span class="toc-number">1.</span> <span class="toc-text">nginx在架构体系中的位置和作用</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%AE%89%E8%A3%85"><span class="toc-number">2.</span> <span class="toc-text">安装</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#nginx%E5%AE%89%E8%A3%85%E7%AC%AC%E4%B8%89%E6%96%B9%E6%A8%A1%E5%9D%97"><span class="toc-number">2.1.</span> <span class="toc-text">nginx安装第三方模块</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Nginx%E7%9B%AE%E5%BD%95%E7%BB%93%E6%9E%84"><span class="toc-number">3.</span> <span class="toc-text">Nginx目录结构</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Nginx%E5%B8%B8%E7%94%A8%E5%91%BD%E4%BB%A4"><span class="toc-number">4.</span> <span class="toc-text">Nginx常用命令</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#nginx-conf%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6%E7%BB%93%E6%9E%84"><span class="toc-number">5.</span> <span class="toc-text">nginx.conf配置文件结构</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Nginx%E9%85%8D%E7%BD%AE"><span class="toc-number">6.</span> <span class="toc-text">Nginx配置</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#demo"><span class="toc-number">6.1.</span> <span class="toc-text">demo</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%B8%A6%E6%B3%A8%E8%A7%A3%E7%9A%84%E9%85%8D%E7%BD%AE"><span class="toc-number">6.2.</span> <span class="toc-text">带注解的配置</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Nginx%E6%97%A5%E5%BF%97"><span class="toc-number">6.3.</span> <span class="toc-text">Nginx日志</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%AE%BE%E7%BD%AEaccess-log"><span class="toc-number">6.3.1.</span> <span class="toc-text">设置access_log</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#log-format%E8%87%AA%E5%AE%9A%E4%B9%89%E6%A0%BC%E5%BC%8F"><span class="toc-number">6.3.2.</span> <span class="toc-text">log_format自定义格式</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%AE%BE%E7%BD%AEerror-log"><span class="toc-number">6.3.3.</span> <span class="toc-text">设置error_log</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%97%A5%E5%BF%97%E9%85%8D%E7%BD%AE%E5%92%8C%E5%8F%8A%E5%88%87%E5%89%B2"><span class="toc-number">6.3.4.</span> <span class="toc-text">日志配置和及切割</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%99%9A%E6%8B%9F%E4%B8%BB%E6%9C%BA"><span class="toc-number">6.4.</span> <span class="toc-text">虚拟主机</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%B7%AF%E7%94%B1%E2%80%94%E2%80%94Location%E7%9A%84%E4%BD%BF%E7%94%A8"><span class="toc-number">6.5.</span> <span class="toc-text">路由——Location的使用</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%AF%AD%E6%B3%95%E8%A7%84%E5%88%99"><span class="toc-number">6.5.1.</span> <span class="toc-text">语法规则</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%AF%AD%E6%B3%95%E8%A7%84%E5%88%99%E6%80%BB%E7%BB%93"><span class="toc-number">6.5.2.</span> <span class="toc-text">语法规则总结</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#location%E6%B5%8B%E8%AF%95"><span class="toc-number">6.5.3.</span> <span class="toc-text">location测试</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E6%B5%8B%E8%AF%951"><span class="toc-number">6.5.3.1.</span> <span class="toc-text">测试1</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E6%B5%8B%E8%AF%952"><span class="toc-number">6.5.3.2.</span> <span class="toc-text">测试2</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E6%B5%8B%E8%AF%953"><span class="toc-number">6.5.3.3.</span> <span class="toc-text">测试3</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E6%B5%8B%E8%AF%954"><span class="toc-number">6.5.3.4.</span> <span class="toc-text">测试4</span></a></li></ol></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%8F%8D%E5%90%91%E4%BB%A3%E7%90%86"><span class="toc-number">6.6.</span> <span class="toc-text">反向代理</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%9D%99%E6%80%81%E4%BB%A3%E7%90%86"><span class="toc-number">6.7.</span> <span class="toc-text">静态代理</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#rewrite%E4%BD%BF%E7%94%A8"><span class="toc-number">6.8.</span> <span class="toc-text">rewrite使用</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%AF%AD%E6%B3%95"><span class="toc-number">6.8.1.</span> <span class="toc-text">语法</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#flag%E5%90%84%E4%B8%AA%E5%8F%82%E6%95%B0%E8%AF%B4%E6%98%8E"><span class="toc-number">6.8.2.</span> <span class="toc-text">flag各个参数说明</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8"><span class="toc-number">6.8.3.</span> <span class="toc-text">使用</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%B4%9F%E8%BD%BD%E5%9D%87%E8%A1%A1%E2%80%94%E2%80%94upstream"><span class="toc-number">6.9.</span> <span class="toc-text">负载均衡——upstream</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%AF%AD%E6%B3%95-1"><span class="toc-number">6.9.1.</span> <span class="toc-text">语法</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8-1"><span class="toc-number">6.9.2.</span> <span class="toc-text">使用</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#ip-hash"><span class="toc-number">6.9.3.</span> <span class="toc-text">ip_hash</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#weight"><span class="toc-number">6.9.4.</span> <span class="toc-text">weight</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#down"><span class="toc-number">6.9.5.</span> <span class="toc-text">down</span></a></li></ol></li></ol></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="fas fa-history"></i><span>最新文章</span></div><div class="aside-list"><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/blog/springcloud/nacos%E4%B8%AD%E7%9A%84%E4%B8%80%E4%BA%9B%E7%BB%86%E8%8A%82/05-Nacos%E4%B8%AD%E7%9A%84AbstractNacosTaskExecuteEngine/" title="05-Nacos中的AbstractNacosTaskExecuteEngine">05-Nacos中的AbstractNacosTaskExecuteEngine</a><time datetime="2021-11-27T12:00:40.000Z" title="发表于 2021-11-27 20:00:40">2021-11-27</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/blog/springcloud/nacos%E4%B8%AD%E7%9A%84%E4%B8%80%E4%BA%9B%E7%BB%86%E8%8A%82/04-Server%E5%92%8CClient%E5%8A%A8%E6%80%81%E8%8E%B7%E5%8F%96nacos%E5%9C%B0%E5%9D%80/" title="04-Server和Client动态获取nacos地址">04-Server和Client动态获取nacos地址</a><time datetime="2021-11-27T12:00:39.000Z" title="发表于 2021-11-27 20:00:39">2021-11-27</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/blog/springcloud/nacos%E4%B8%AD%E7%9A%84%E4%B8%80%E4%BA%9B%E7%BB%86%E8%8A%82/03-Nacos%E7%9A%84%E5%8F%91%E5%B8%83%E4%B8%8E%E8%AE%A2%E9%98%85/" title="03-Nacos的发布与订阅">03-Nacos的发布与订阅</a><time datetime="2021-11-27T12:00:38.000Z" title="发表于 2021-11-27 20:00:38">2021-11-27</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/blog/springcloud/nacos%E4%B8%AD%E7%9A%84%E4%B8%80%E4%BA%9B%E7%BB%86%E8%8A%82/02-Nacos%20Server%E4%B8%AD%E7%9A%84Secured%E6%B3%A8%E8%A7%A3/" title="02-Nacos Server中的Secured注解">02-Nacos Server中的Secured注解</a><time datetime="2021-11-27T12:00:37.000Z" title="发表于 2021-11-27 20:00:37">2021-11-27</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/blog/springcloud/nacos%E4%B8%AD%E7%9A%84%E4%B8%80%E4%BA%9B%E7%BB%86%E8%8A%82/01-Nacos%20Server%E6%9C%8D%E5%8A%A1%E6%B3%A8%E5%86%8C%E8%A1%A8%E7%9A%84%E5%86%99%E6%97%B6%E5%A4%8D%E5%88%B6/" title="01-Nacos Server服务注册表的写时复制">01-Nacos Server服务注册表的写时复制</a><time datetime="2021-11-27T12:00:36.000Z" title="发表于 2021-11-27 20:00:36">2021-11-27</time></div></div></div></div></div></div></main><footer id="footer" style="background: linear-gradient(20deg, #0062be, #925696, #cc426e, #fb0347)"><div id="footer-wrap"><div class="copyright">&copy;2020 - 2022 By xyz</div><div class="framework-info"><span>框架 </span><a target="_blank" rel="noopener" href="https://hexo.io">Hexo</a><span class="footer-separator">|</span><span>主题 </span><a target="_blank" rel="noopener" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly</a></div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="fas fa-book-open"></i></button><button id="darkmode" type="button" title="浅色和深色模式转换"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside_config" type="button" title="设置"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="fas fa-list-ul"></i></button><button id="go-up" type="button" title="回到顶部"><i class="fas fa-arrow-up"></i></button></div></div><div id="local-search"><div class="search-dialog"><nav class="search-nav"><span class="search-dialog-title">本地搜索</span><span id="loading-status"></span><button class="search-close-button"><i class="fas fa-times"></i></button></nav><div class="is-center" id="loading-database"><i class="fas fa-spinner fa-pulse"></i><span>  数据库加载中</span></div><div class="search-wrap"><div id="local-search-input"><div class="local-search-box"><input class="local-search-box--input" placeholder="搜索文章" type="text"/></div></div><hr/><div id="local-search-results"></div></div></div><div id="search-mask"></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox.umd.js"></script><script src="https://cdn.jsdelivr.net/npm/node-snackbar/dist/snackbar.min.js"></script><script>function panguFn () {
  if (typeof pangu === 'object') pangu.autoSpacingPage()
  else {
    getScript('https://cdn.jsdelivr.net/npm/pangu/dist/browser/pangu.min.js')
      .then(() => {
        pangu.autoSpacingPage()
      })
  }
}

function panguInit () {
  if (true){
    GLOBAL_CONFIG_SITE.isPost && panguFn()
  } else {
    panguFn()
  }
}

document.addEventListener('DOMContentLoaded', panguInit)</script><script src="/js/search/local-search.js"></script><script>var preloader = {
  endLoading: () => {
    document.body.style.overflow = 'auto';
    document.getElementById('loading-box').classList.add("loaded")
  },
  initLoading: () => {
    document.body.style.overflow = '';
    document.getElementById('loading-box').classList.remove("loaded")

  }
}
window.addEventListener('load',preloader.endLoading())</script><div class="js-pjax"><script>(() => {
  const $mermaidWrap = document.querySelectorAll('#article-container .mermaid-wrap')
  if ($mermaidWrap.length) {
    window.runMermaid = () => {
      window.loadMermaid = true
      const theme = document.documentElement.getAttribute('data-theme') === 'dark' ? 'dark' : 'default'

      Array.from($mermaidWrap).forEach((item, index) => {
        const mermaidSrc = item.firstElementChild
        const mermaidThemeConfig = '%%{init:{ \'theme\':\'' + theme + '\'}}%%\n'
        const mermaidID = 'mermaid-' + index
        const mermaidDefinition = mermaidThemeConfig + mermaidSrc.textContent
        mermaid.mermaidAPI.render(mermaidID, mermaidDefinition, (svgCode) => {
          mermaidSrc.insertAdjacentHTML('afterend', svgCode)
        })
      })
    }

    const loadMermaid = () => {
      window.loadMermaid ? runMermaid() : getScript('https://cdn.jsdelivr.net/npm/mermaid/dist/mermaid.min.js').then(runMermaid)
    }

    window.pjax ? loadMermaid() : document.addEventListener('DOMContentLoaded', loadMermaid)
  }
})()</script></div><script src="https://cdn.jsdelivr.net/npm/pjax/pjax.min.js"></script><script>let pjaxSelectors = ["title","#config-diff","#body-wrap","#rightside-config-hide","#rightside-config-show",".js-pjax"]

var pjax = new Pjax({
  elements: 'a:not([target="_blank"])',
  selectors: pjaxSelectors,
  cacheBust: false,
  analytics: false,
  scrollRestoration: false
})

document.addEventListener('pjax:send', function () {

  // removeEventListener scroll 
  window.tocScrollFn && window.removeEventListener('scroll', window.tocScrollFn)
  window.scrollCollect && window.removeEventListener('scroll', scrollCollect)

  typeof preloader === 'object' && preloader.initLoading()
  document.getElementById('rightside').style.cssText = "opacity: ''; transform: ''"
  
  if (window.aplayers) {
    for (let i = 0; i < window.aplayers.length; i++) {
      if (!window.aplayers[i].options.fixed) {
        window.aplayers[i].destroy()
      }
    }
  }

  typeof typed === 'object' && typed.destroy()

  //reset readmode
  const $bodyClassList = document.body.classList
  $bodyClassList.contains('read-mode') && $bodyClassList.remove('read-mode')

})

document.addEventListener('pjax:complete', function () {
  window.refreshFn()

  document.querySelectorAll('script[data-pjax]').forEach(item => {
    const newScript = document.createElement('script')
    const content = item.text || item.textContent || item.innerHTML || ""
    Array.from(item.attributes).forEach(attr => newScript.setAttribute(attr.name, attr.value))
    newScript.appendChild(document.createTextNode(content))
    item.parentNode.replaceChild(newScript, item)
  })

  GLOBAL_CONFIG.islazyload && window.lazyLoadInstance.update()

  typeof chatBtnFn === 'function' && chatBtnFn()
  typeof panguInit === 'function' && panguInit()

  // google analytics
  typeof gtag === 'function' && gtag('config', '', {'page_path': window.location.pathname});

  // baidu analytics
  typeof _hmt === 'object' && _hmt.push(['_trackPageview',window.location.pathname]);

  typeof loadMeting === 'function' && document.getElementsByClassName('aplayer').length && loadMeting()

  // prismjs
  typeof Prism === 'object' && Prism.highlightAll()

  typeof preloader === 'object' && preloader.endLoading()
})

document.addEventListener('pjax:error', (e) => {
  if (e.request.status === 404) {
    pjax.loadUrl('/404.html')
  }
})</script><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script></div></body></html>